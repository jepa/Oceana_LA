---
title: "Contributions of marine capture fisheries to the domestic livelihoods and seafood consumption of Brazil Chile and Peru"
author: "Juliano Palacios Abrantes, MSc, Camila Vargas, MSc, Daniel Viana, PhD, Maria I. Rivera, MSc, Rocío López, MSc, Santiago de la Puente, MSc, Andrés M. Cisneros-Montemayor, PhD"
subtitle: "Response to Oceana Request for Proposal: Most Important Fisheries for People Study"
output:
  html_notebook:
    collapsed: no
    number_sections: yes
    smooth_scroll: yes
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
---

```{r setup, eval = T, echo=F, warning=F,message=F}

#### READ ME !!! ####
# Run this chunk before knit so you make sure you have all pkgs installed in R
# Please include any package used in your analysis

ipak <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg)) 
    install.packages(new.pkg, dependencies = TRUE)
  sapply(pkg, require, character.only = TRUE)
}

#### Library ####
packages <- c(
  # "readxl", # Read dataframe
  "dplyr", # Data manipulation
  "tidyr", # Data manipulation
  "ggplot2", #Nice grpahs and spatial analysis
  "plotly",
  # "rgdal",
  # "RColorBrewer",
  "knitr",
  "kableExtra",
  "data.table"#,
  # "ggrepel",
  # "gridExtra",
  # "ggmap",
  # "rgeos",
  # "sp",
  # "rgdal", #Spatial analysis 
  # "tools" #Spatial analysis 
)

suppressWarnings(
  suppressMessages(
    suppressPackageStartupMessages(
      ipak(packages)
    )
  )
)


#### Functions ####

# Note that the main function is on a separate file (corefx.r)
source('Functions/corefx.R')

#### For all plots look alike ###

ggtheme_plot <- function() {
  theme(
    plot.title = element_text(size = rel(1.25), hjust = 0, face = "bold"),
    panel.background = element_blank(),
    strip.background = element_blank(),
    # strip.text       = element_text(size = base_size, face = "italic"),
    panel.border     = element_blank(),
    panel.grid.minor = element_blank(),
    panel.grid.major = element_blank(),
    axis.ticks = element_blank(),
    axis.text.x = element_text(size = 16),
    axis.text.y = element_text(size = 16),
    axis.title = element_text(size = 16),
    legend.key = element_rect(colour = NA, fill = NA),
    legend.position  = "top",
    legend.title = element_text(size = 18),
    legend.text = element_text(size = 16),
    strip.text.x = element_text(size = 20, colour = "darkgrey")
  )
}


#### Datasets ####

# International Datasets #### 

# All datafiles should be in THIS path
Int_Data_Path <- "./clean_databases/International/"

#### SAU dataset used for international analysis chunks:
# 1, 2 & 3, 4

# # # File name
# SAU_F_Name <- "SAU_Dataset.csv"
# # #read dataset
# SAU_Database <- fread(paste(Int_Data_Path,
#                             SAU_F_Name,
#                             sep = ""))
# #### UN dataset used for international analysis chunks:
# # 4
# 
# UN_F_Name <- "UN_Dataset.csv"
# 
# UN_Database <- read.csv(paste(Int_Data_Path,
#                               UN_F_Name,
#                               sep = ""))


#### International dataset ####

UN_F_Name <- "International_Data.csv"

International_D<- read.csv(paste(Int_Data_Path,
                              UN_F_Name,
                              sep = ""))

```

# Project Goal
Determine the contribution of specific fisheries to domestic fish consumption and domestic
livelihoods throughout Brazil, Chile, and Peru.

# Key Objectives

- Critical analysis highlighting important capture fisheries for domestic food security, in the context
of vulnerable populations and regions.
- Determine most important capture fisheries for food provision, and domestic seafood consumption
patterns through time and space.
- Determine most important capture fisheries and fisheries sectors for regional employment and
income.
- Determine most important capture fisheries and fisheries sectors for domestic catch and landed
value.

Deliverable
- Final report including a critical analysis of domestic seafood consumption, related fisheries
employment and income, and general fishery conditions of each nation included (Brazil, Chile and
Peru).
- National datasets and associated R-script, properly documented for replicating analyses and results.
- Summary of key uncertainties, data gaps and priority areas for future research and policy.

# Excecutive Summary

# Introduction

Latin American nations include the main fisheries regions of the world in terms of landings and, with a high (51%) proportion of net seafood production traded locally, domestic fisheries remain highly important for national food security. The UN Food and Agriculture Organization estimates that Latin American countries consumed around 6.2 million tons of fish in 2015, averaging a per capita food fish consumption of 9.8 kg/year. The contribution of fisheries’ to food security and livelihoods is particularly pertinent given the ongoing World Trade Negotiations on fishery subsidies disciplines, as these are partially intended to avoid trade and operational distortions that may threaten local food security in maritime nations.

In 2016, total fish landings in Chile and Peru, two of the world’s top fishing nations, averaged 8 million tons per year [@Fishstat]. In Peru, the seafood sector generates over US 1.7 billion per year, supporting over 200 thousand jobs3. Moreover, Chile’s aquaculture production is among the largest of the world1 and fish meal and salmon exports generate over US$2.2 billion per year4. Despite comparatively lower catches, Brazil’s fisheries sustain thousands of local families in coastal areas5-6, and inland captures are among the largest of the world1. In Latin America size matters as 90% of Landings from small scale fisheries (SSF) are paramount in Latin America, as 90% of all motorized fishing vessels are under 12m
length1. However, this sector is among the most marginalized groups in the region 7, despite it being critical to achieving Sustainable Development Goal 1, “Eradicating hunger,” as highlighted by the recent FAO small scale fisheries guidelines that explicitly links the sector with food security and poverty eradication [@Fishstat].

Given the increasing pressures on vulnerable populations, including climate change but also rapid policy and market shifts, it is imperative to highlight the critical importance of particular capture fisheries for meeting domestic seafood supply. This knowledge can help guide future policies to ensure economic development does not jeopardize health and livelihoods in (particularly coastal) communities.

# Methods

The objective of this project, for each nation considered, was to determine the domestic seafood consumption (regionally, as possible) and its relationship with local employment in wild capture fisheries. Given that seafood is a widely traded commodity and that aquaculture has steadily increased supply into markets, meeting this objective will involve using species-specific data on domestic catches, aquaculture, and seafood imports and exports in order to highlight the most important species and fisheries for contributing to local and national food security.

Figure 1 below is a conceptual diagram of the anticipated methods to be undertaken in each nation. These methods directly link to the objectives proposed in the project Terms of Reference. Given the nature of fisheries data and governance systems, we anticipate that each of the nations considered will present unique challenges. Nevertheless, the overall approach (as captured in Fig. 1) will be used to maintain consistency in methods and comparability of results across nations, of course acknowledging specific uncertainties as appropriate.

Based on the best available data in each country, total seafood supply will be estimated as the sum of per-species production of domestic catch and aquaculture (minus exports), plus the sum of species specific net imports. Catch statistics will also be broken down by sectors whenever possible, including artisanal, industrial, and subsistence catches. In the case of domestic catch, inputs to aquaculture are subtracted from production (similar to exports); this is anticipated to be particularly relevant for large industrialized fisheries for small pelagics that are almost entirely reduced into fish feeds for aquaculture. The distribution of consumption (demand) of this seafood supply will be based on regional (as available) estimates of seafood consumption per capita and regional populations. An important additional aspect for the critical analysis portion of the project will be to link these regions with available socioeconomic and governance indicators, providing a basis for discussing relative vulnerabilities to potential
changes in seafood supply.


![Figure 1.](Report_Figures/Fig1.png)


## Analysis

<!-- Fishing revenue integrates the different ex-vessel price that landings have, depending on the final destination: direct human consumption (DHC) and indirect human consumption (IHC). Therefore, total revenue (*R*) is estimated in the SAU database as follows: -->

<!-- $$R = \sum_{i = 1}^n (L_{i}*\beta_{i})*\beta P_{i} + (L_{i}*\alpha _{i}) *\alpha P_{i}$$ -->


<!-- where *L* is total landings for species *i*, $\beta$ is the proportion of total landings destined to DHC, $\beta P$ s the ex-vessel price for DHC, $\alpha$ is the proportion of total landings destined to IHC and $\alpha P$ is the ex-vessel price for it. -->

<!-- In addition to the landings data, we used the UNCD database to determine the value (US dollars) of fish and crustaceans, mollusks and other aquatic invertebrates imported and exported by Brazil, Chile and Peru in 2014. We estimate the net trade (*NT*) as follows: -->

<!-- $$NT = (E-I)-RI$$ -->
<!-- where *E* is exports, *I* is imports and *RI* is re-imports. Due to the lack of detail in the UNCD database, all taxa in the SAU database had to be combined. Therefore, the estimate of total revenue from fisheries-related products per country in 2014 is an addition of the total landings revenue (all species) and the UN net trade. -->

<!-- Finally, for estimating the contribution of landings and imports to domestic seafood consumption, we used data published by Cashion *et al.*, 2018 on human direct consumption and processing (fish meal and fish oil). -->


```{r Variables, eval = T, echo = F}

data.table(
  Symbol = c(
    "C",
    "A",
    "I",
    "E",
    "D",
    "O",
    "P",
    "L",
    "TDFS",
    "NDFS",
    "TFS",
    "NSS"
  ),
  Description = c(
    "Fish catch, i.e., wild capture production.",
    "Aquaculture production.",
    "Fish imports.",
    "Fish exports.",
    "Rate of losses () from discards (D) at sea.",
    "Rate of losses from other uses (O), i.e., not for human consumption.",
    "Rate of losses from processing (P), i.e., during canning, filleting, etc.",
    "Landings from wild capture production (catch minus discards).",
    "Total domestic fish supply. Total amount of fish produced in the country.",
    "Net domestic fish supply. Total amount of fish produced in the country, minus exports and discards.",
    "Total fish supply. Total amount of fish in the country (NDFS plus imports).",
    "Net seafood supply. Effective amount of fish for human consumption in the country (TFS for human consumption, minus processing waste)."
  )
) %>% 
  kable("latex", booktabs = T) %>% 
  kable_styling(full_width = F) %>% 
   column_spec(2, width = "15cm") #wraps text in column2

```

$${TDFS_i} = {C_i} + {A_i}$$
Note that, to avoid double-counting fish production, domestic catch that is fed to farmed fish should be subtracted from overall production. This was done as possible given available country information and context (i.e., this may be more of an issue for some countries than others).

$${NDFS_i} = {L_i} + {A_i} - {E_i} $$

$$ {L_i} = {C_i} - ({C_i} * {\lambda_{d,i}} )$$

where the second term in Equation 3 allows for a calculation of total discards in each country.
In Equations 4 and 5, we assume that all imported seafood (we do not include imports not for human consumption, e.g., fish meal) is ready to be consumed and thus do not include losses from processing. We also assume that all aquaculture production is for human consumption and that none of this production is discarded, though processing losses do occur as in production from capture fisheries (e.g., farmed and wild caught shrimps would receive similar processing).


$${TFS_i} = NDFS_i + I_i$$

Therefore, national seafood supply will be estimated for each country and species as follows:

$$NSS_i = [(L_i - L_i * {\lambda_{o,i}} + A_i] * {\lambda_{p,i}}- E_i + I_i$$


### International Analysis

The first approach that we did was to determine domestic seafood consumption, and its relationship with local employment in wild capture fisheries from international databases. While this first step represents the most broad analysis, it gives an idea of general country-level trends as well as information available to focus at more specific levels. The international analysis done using three main datasets:

<!-- 1. The Sea Around Us Dataset (SAU) has reconstructed fisheries catches for all three countries dating from 1950 to 2014. These data present a more accurate and complete picture of global fisheries than nationally collected data (nor the FAO dataset) [@Zeller2016]. Data extracted from SAU for Chile included the islands Juan Fernandez, Easter, and Desventuradas. For Brazil landings data included Fernando de Noronha, St Paul and St. Peter Archipelagos, and Trindade & Martim Vaz islands. -->
<!-- 2. The United Nations Come-trade database (UNCD) is managed by the Trade Statistics Branch of the United Nations Statistics Division. The UNCD has detailed trade data by commodity or services category for both merchandise trade and trade in services from 1962 to 2017 (https://unstats.un.org/unsd/trade/default.asp). -->
3. A recent study estimated the proportion of fish landings designated to human direct consumption and fish meal and fish oil[@Cashion:2018]. Such study used the SAU database, internal reports and other methods for estimating total landings devoted to each segment for all countries in the world.
4. The FAO-SOFIA Catch and trade database.

For the former analysis we used the FAO database to estimate the total landings (tons) of Chile, Brasil, and Peru in 2014, the last year with results in all database. All fishing sectors were aggregated (Industrial, Subsistence and Artisanal) and ** COMMENT: "Recreational" was ignored as it does not contribute to local food security.** Other countries that fish within Chile, Peru and Brasil were also not included in the analysis for the same reason. Landings were grouped by taxa excluding those not identified (e.g. "Marine fishes not identified"). We used the SAU database under the same method to estimate the revenue (US dollars) from each fishery.The SAU landings database reconstruction methods for each country can be accessed for Brazil[@REF], Chile[@REF], and Peru[@REF]. We then used the Tim *et al., 2018* database to estimate how much of the landings go to direct human consumption and how much goes to indirect human consumption...


## Brazil Specifics
Briefly state data used and how we combine them

## Chile Specifics
Briefly state data used and how we combine them

## Peru Specifics
Briefly state data used and how we combine them

# Results
## International
### Domestic Fish Consumption (General)
### Employment and Income (General)
### Fisheries Context (General)
Results from the international analysis shows a clear dominance in fisheries landings of both Chile and Peru over Brazil, even thou Brazil captures around 3 times more species than the former. In terms of total fishing revenue, all nations are similar (**Table XX**)

```{r Total_Table, eval = T, echo = F}

Totals <- International_data %>%
  gather("Variable","Value",6:13) %>% 
  filter(Unit == "Tonnes") %>% 
  group_by(Country,Sci.Name.Fb,Variable) %>%
  summarise_if(is.numeric,mean,na.rm =T) %>% 
  group_by(Country,Variable) %>% 
  summarise(
    "Totals" = round(sum(Value,na.rm=T)),
    "Exploited Species" = n()
  ) %>%
  filter(Variable %in% c("Aquaculture","Capture","Exports","Imports")) %>% 
  tidyr::spread(Variable,Totals)

kable(Totals)

```

When we analyze the top ten species in terms of landing volume (tons) and value (USD), we find different trends between and within countries. Brazil's most prolific fishery in 2014 was *Umbrina canosai*, a croaker fished in the southern part of the country, however, the most exploited specie (in terms of landings) was the ray-finned fish *Sardinella brasiliensis*. For Chile, the most valuable and landed fishery was *Engraulis ringens*, Peruvian anchoveta. Finally, Peru most valuable fishery in 2014 was the Peruvian scallop *Argopecten purpuratus* but like Chile, *Engraulis ringens* was the most landed species (**Fig. XX**).

```{r International_Data, eval = T, echo = F, warning =F, message = F, fig.height = 25, fig.width= 20, fig.cap= ""}

corefx(
  Species = International_D$Sci.Name.Fb,
  Country = International_D$Country,
  Catch = International_D$Capture,
  Dis = 0.20,
  DHC = International_D$DHC_Use,
  PL = 0.20,
  AP = International_D$Aquaculture,
  A_PL = 0.20,
  I_DHC = International_D$IHC,
  Exp = International_D$Exports,
  Result = "T",
  n = 5
  )

```



```{r SAU_Landings_Data, eval = F, echo = F, warning =F, message = F, fig.height = 25, fig.width= 20, fig.cap= "Top 10 species by landings (left) and value (right)\n from the SAU dataset. Red bars represent species not present in the other category. White boxes represent the contribution of that speciest to the total variable"}


Totals_Plot <- Totals %>%
  select(-2) %>%
  tidyr::gather("Variable","Totals",2:3)

# Including the proportion of the catch/value of each species
SAU_Prop <- SAU_Database %>%
  left_join(Totals_Plot,
            by = c("Reporter", "Variable")) %>%
  mutate(
    Proportion = round((Value/Totals)*100,2)
  ) %>%
  group_by(Reporter,Variable) %>%
  top_n(n = 10, wt = Proportion) %>%
  group_by(Reporter,scientific_name) %>%
  mutate(Repeated = n()) %>%
  mutate(Repeated = ifelse(Repeated == 1, "No", "Yes"))

# Including the accumulative proportion of plotted species

Prop_Total <- SAU_Prop %>%
  group_by(Reporter,Variable) %>%
  summarise(
    Tot_Prop = sum(Proportion),
    Location = max(Value)
  )

ggplot() +
  geom_bar(data = SAU_Prop, # Catch and value data
           aes(
             x= reorder(scientific_name,-Proportion),
             y = Value/1000, #thousands
             fill = Repeated
           ),
           stat = "identity"
  ) +
  geom_label(data = SAU_Prop, # Species proportion data (Barx boxes)
             aes(
               x = reorder(scientific_name,-Proportion),
               y = Value/1000,
               label = paste(as.character(Proportion),"%",sep = " ")
             )
  ) +
  geom_label(data = Prop_Total, # Total proportion data
             aes(
               x = 9,
               y = Location/1100,
               label = paste("Proportion of total",Variable, "\n of selected species\n",as.character(Tot_Prop),"%",sep = " ")
             )
  ) +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1,
                                   face = "italic")
  ) +
  scale_fill_manual(values =c("darkred",
                              "darkgreen"),
                    name ="Repeated") +
  facet_wrap(~Reporter + Variable,
             scales = "free",
             ncol = 2) +
  labs(
    # title="Top 25 species by landings (left) and value (right)\n from the SAU dataset",
    x ="Species",
    y = "Values \n (Thousand of Tonns & US Dollars)"
  ) +
  ggtheme_plot() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, face = "italic", size = 16))


# For interactive plot
# Name the plot and then call it
# ggplotly(g_plot)
```

In addition to the internal fish production, Brazil, Chile and Peru all import and export fish (**Fig. XXX**). According to the UN data, Brazil spends more money importing fish than what it makes from producing it and exporting that production. In the other hand, both Chile and Peru have positive surplus from their fisheries and commerce activities being Chile the most "*profitable*" country.

```{r Trade, eval = T, echo = F, warning=F, fig.height = 10, fig.width= 15, fig.cap= "Revenue from fisheries production, imports and exports for each nation from the UN database."}


UN_Database %>%
  left_join(Totals,
            by = "Reporter") %>%
  mutate(Fish_Industry_Total = Net_Trade_Value + Landings_Value) %>%
  select(1:3,5,10) %>%
  tidyr::gather("Action","Value",2:5) %>%
  ggplot(.,
         aes(
           x = Action,
           y = Value/1000000,
           # colour = Action
           fill = Action
         )
  ) +
  # geom_point()
  geom_bar(stat = "identity",
           width = 0.5 #Bar size
  ) +
  facet_wrap(~Reporter) +
  scale_fill_manual(values =c("green4",
                              "blue",
                              "red",
                              "green3",
                              "skyblue"
  )
  ) +
  coord_flip() +
  labs(title="",
       x ="Countries",
       y = "Million US Dollars"
  ) +
  ggtheme_plot()

```

## Results Brazil
### Domestic Fish Consumption (General)
### Employment and Income (General)
### Fisheries Context (General)
## Results Chile
### Domestic Fish Consumption (General)
### Employment and Income (General)
### Fisheries Context (General)
## Results Peru
### Domestic Fish Consumption (General)
### Employment and Income (General)
### Fisheries Context (General)
# Critical Analysis
## Overall of the region
### Brazil
### Chile
### Peru
# Conclusions
# References
# Data
# Supplemental Material List

