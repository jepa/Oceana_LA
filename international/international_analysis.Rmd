---
title: "International Analysis"
output:
  pdf_document: default
  html_notebook: default
  html_document:
    df_print: paged
---

```{r setup, eval=T, echo=F, warning=F,message=F}

#### READ ME !!! ####
# Run this chunk before knit so you make sure you have all pkgs installed in R

ipak <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg)) 
    install.packages(new.pkg, dependencies = TRUE)
  sapply(pkg, require, character.only = TRUE)
}

#### Library ####
packages <- c(
  # "readxl", # Read dataframe
  "dplyr", # Data manipulation
  "tidyr", # Data manipulation
  "ggplot2", #Nice grpahs and spatial analysis
  "plotly",
  # "rgdal",
  # "RColorBrewer",
  "knitr",
  # "kableExtra",
  "data.table"#,
  # "ggrepel",
  # "gridExtra",
  # "ggmap",
  # "rgeos",
  # "sp",
  # "rgdal", #Spatial analysis 
  # "tools" #Spatial analysis 
)

suppressWarnings(
  suppressMessages(
    ipak(packages)
  )
)

### Set up pannel 

# Choose countries to analyze
Countries <- c("Brazil","Chile","Peru")
# Year(s) to be analized
Year_an <- 2014

```

### Landings data
- Estimate landings and revenue for each country form the Sea Around Us (http://www.seaaroundus.org/) database. 

#### Notes

- Using reconstructed catch
- Filter out external countries (China, South Korea and "unknown")
- Removed Chile's reported landings in Peruvian waters

#### Questions to discuss with the team:
- Should we remove Recreational landings? 
- Removed Chile's reported landings in Peruvian waters?

```{r SAU_Landings_Data, eval = T, echo = T, warning =F, message = F, fig.height = 15, fig.width= 10}

#Data Path
Data_Path <- "./information/raw_databases/"
# File name
SAU_F_Name <- "SAU EEZ 76,969,77,970,604,152,153,154,155 v47-0.csv"
#read dataset
SAU <- fread(paste(Data_Path,SAU_F_Name,
                   sep = ""))
# Data exploration
# names(SAU)
# head(SAU)
# unique(SAU$fishing_sector) # "Industrial"   "Subsistence"  "Artisanal"    "Recreational"

# Countries excluded from the analysis
unique(SAU$fishing_entity) # There are 29 countries fishing in these waters, fill filter them
Countries <- c("Brazil","Chile","Peru")
unique(SAU$area_name)
#Main fisheries

SAU$scientific_name <- gsub(" ", "\n",SAU$scientific_name)

# Plot <- #For dynamic plot
SAU_Clean <- # FOr saving the plot
  SAU %>% 
  filter(scientific_name != "Marine\nfishes\nnot\nidentified") %>%  #Removed but top in B and P
  filter(fishing_entity %in% Countries) %>% # Remove other fishing nations
  group_by(year,
           scientific_name, # Trade data is too generic for species details
           fishing_entity#,
           # fishing_sector # #Trade data is too generic for sector details
  ) %>%
  summarise(
    Total_tonnes = sum(tonnes),
    Landings_Value = sum(landed_value)
  ) %>%
  filter(year == Year_an) %>%  # Choose year to be analyzed
  rename(Reporter = fishing_entity) %>%  # Change name of variable to match UN trade dataset
  # filter(area_name != "Peru" | Reporter != "Chile") %>% 
  tidyr::gather("Variable","Value",4:5)  %>% 
  group_by(Reporter,Variable) %>%
  top_n(n = 10, wt = Value) %>%  # Top 10, change if interactive plot
  # Determine what species are in both "Top" categories
  group_by(Reporter,scientific_name) %>%  
  mutate(Repeated = n()) %>% 
  mutate(Repeated = ifelse(Repeated == 1, "No", "Yes"))

# Plot 
ggplot(SAU_Clean,
       aes(
         x= reorder(scientific_name,-Value),
         y = Value/1000, #thousands
         fill = Repeated
       )
) +
  geom_bar(stat = "identity") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1,
                                   face = "italic")
  ) +
  scale_fill_manual(values =c("darkred",
                              "darkgreen"),
                    name ="Repeated") +
  facet_wrap(~Reporter + Variable,
             scales = "free",
             ncol = 2) +
  labs(title="Top 25 species by landings (left) and value (right)\n from the SAU dataset",
       x ="Species",
       y = "Values \n (Thousand of Tonns & US Dollars)"
  )


# For interactive plot
# Name the plot and then call it
# ggplotly(g_plot)


## Totals per Country ####

SAU_Tot <- SAU %>% 
  group_by(area_name,
           year,
           # scientific_name, # Trade data is too generic for species details
           fishing_entity#,
           # fishing_sector # #Trade data is too generic for sector details
  ) %>% 
  summarise(
    Total_tonnes = sum(tonnes),
    Landings_Value = sum(landed_value)
  ) %>% 
  filter(fishing_entity %in% Countries, # Remove China, Korea and unknown fishing country
         year == Year_an) %>%  # Choose year to be analyzed
  rename(Reporter = fishing_entity) %>%  # Change name of variable to match UN trade dataset
  filter(area_name != "Peru" | Reporter != "Chile") # Remove Chile report in Peruvean waters*

head(SAU_Clean)

# names(SAU_Clean)
# head(SAU_Clean)
# unique(SAU_Clean$fishing_entity)

# Clenaed!

#Write csv
# write.csv(SAU_Clean,
#           "SAU_Dataset.csv",
#           row.names = FALSE)


#### Proportion of the catch ####

Totals <- SAU %>% 
  filter(scientific_name != "Marine\nfishes\nnot\nidentified") %>%  #Removed but top in B and P
  filter(fishing_entity %in% Countries) %>% # Remove other fishing nations
  group_by(
    year,
    fishing_entity
  ) %>%
  summarise(
    Total_tonnes = sum(tonnes),
    Landings_Value = sum(landed_value)
  ) %>%
  filter(year == Year_an) %>% 
  ungroup() %>% 
  select(-year) %>% 
  tidyr::gather("Variable","Totals",2:3)

SAU_Spp <- SAU %>% 
  filter(scientific_name != "Marine\nfishes\nnot\nidentified") %>%  #Removed but top in B and P
  filter(fishing_entity %in% Countries) %>% # Remove other fishing nations
  group_by(
    year,
    scientific_name, # Trade data is too generic for species details
    fishing_entity
  ) %>%
  summarise(
    Total_tonnes = sum(tonnes),
    Landings_Value = sum(landed_value)
  ) %>%
  filter(year == Year_an) %>% 
  ungroup() %>% 
  select(-year) %>% 
  tidyr::gather("Variable","Partials",3:4) %>% 
  left_join(Totals,
            by = c("fishing_entity", "Variable")) %>% 
  mutate(
    Proportion = round((Partials/Totals)*100,2)
  ) %>% 
  group_by(fishing_entity,Variable) %>%
  top_n(n = 10, wt = Proportion) %>% 
  select(-4:-5) %>% 
  rename(Reporter = fishing_entity) %>%
  left_join(SAU_Clean,
            by = c("scientific_name","Reporter","Variable"))%>%  
  mutate(Repeated = n()) %>% 
  mutate(Repeated = ifelse(Repeated == 1, "No", "Yes"))

Prop_Total <- SAU_Spp %>% 
  group_by(Reporter,Variable) %>% 
  summarise(
    Tot_Prop = sum(Proportion),
    Location = max(Value)
  )


ggplot() +
  geom_bar(data = SAU_Spp,
           aes(
             x= reorder(scientific_name,-Value),
             y = Value/1000, #thousands
             fill = Repeated
           ),
           stat = "identity"
  ) +
  geom_label(data = SAU_Spp,
             aes(
               x = reorder(scientific_name,-Value),
               y = Value/1000,
               label = paste(as.character(Proportion),"%",sep = " ")
             )
  ) +
  geom_label(data = Prop_Total,
             aes(
               x = SAU_Spp$scientific_name[10],
               y = Location/1000,
               label = paste(as.character(Tot_Prop),"%",sep = " ")
             )
  ) +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1,
                                   face = "italic")
  ) +
  scale_fill_manual(values =c("darkred",
                              "darkgreen"),
                    name ="Repeated") +
  facet_wrap(~Reporter + Variable,
             scales = "free",
             ncol = 2) +
  labs(title="Top 25 species by landings (left) and value (right)\n from the SAU dataset",
       x ="Species",
       y = "Values \n (Thousand of Tonns & US Dollars)"
  )


```

```{r FAO_Landings_Data, eval = T, echo = T}

#Data Path
Data_Path <- "./information/raw_databases/"
# File name
FAO_F_Name <- "INPUT FAO Fishstat 2018.csv"
#read dataset
FAO <- read.csv(paste(Data_Path,FAO_F_Name,
                      sep = ""))

# head(FAO)
# names(FAO)

Clean_FAO <- FAO %>% 
  filter(Country %in% Countries) %>% 
  select(Country,
         Sector,
         Group,
         Environment,
         Trade.Flow,
         Unit,
         X2010:X2016) %>% 
  gather("Year","Value",7:13)

# Remove "X" from year to make it numeric
Clean_FAO$Year<- gsub( 
  "X", "", Clean_FAO$Year)

head(Clean_FAO)
names(Clean_FAO)
unique(Clean_FAO$Country)
unique(Clean_FAO$Sector)
unique(Clean_FAO$Group)
unique(Clean_FAO$Environment)

#### Ther's something fishy with (Captures) ####

# Peru <- 
# FAO %>% 
#   filter(
#     # Country == "Peru",
#     Sector == "Trade" | Trade.Flow == "Production") %>% 
#   # head()
#   group_by(
#     Sector,
#     Country,
#     Trade.Flow,
#     Unit
#   ) %>% 
#   summarise_at(vars(matches("X20")), sum, na.rm=T) #%>% 
# # head()

### THis Works... Maybe clean FAO???
# Clean_FAO %>% 
# filter(Country == "Peru") %>% 
# # head()
#   group_by(
#     Sector,
#     Trade.Flow
#   ) %>% 
#   summarise_at(vars(matches("X20")), sum, na.rm=T)



#### Overall production per Sector FAO ####

Totals <- Clean_FAO %>% 
  group_by(Country,
           Sector,
           Trade.Flow,
           Unit) %>% 
  summarise(
    Mean = mean(Value, na.rm=T)) #%>% 
# filter(Unit != "Number",
#        Sector != "Trade" | Trade.Flow != "Production"
#        )#Until we figure out this

ggplot(Totals,
       aes(
         x = Sector,
         y = Mean/1000, #thousands
         fill = Trade.Flow
       )
) +
  geom_bar(stat = "identity") +
  facet_wrap(~ Country + Unit,
             ncol = 2,
             scales = "free")


#### Per Species ####

head(Clean_FAO)

Spp_FAO <- Clean_FAO %>% 
  # filter(scientific_name != "Marine\nfishes\nnot\nidentified") %>%  #Removed but top in B and P
  group_by(
    Country,
    Sector, # Trade data is too generic for species details
    Group,
    Trade.Flow,
    Unit
  ) %>%
  summarise_at(vars(matches("X20")), sum, na.rm=T) %>% 
  group_by(Country,
           Sector,
           # Group,
           Trade.Flow,
           Unit) %>%
  # top_n(n = 10, wt = X2016) %>% 
  filter(Unit != "Number",
         Sector != "Trade" | Trade.Flow != "Production" #Until we figure out this
  ) %>% 
  select(-X2015,-X2014) %>% 
  mutate(Year = 2016) %>% 
  rename(Value = X2016)



# Are there any species in different Sectores per country?

Overlap <- Spp_FAO %>% 
  group_by(Country,
           Group,
           Trade.Flow) %>%
  summarise(n(),
            Sectors = paste(Sector,
                            collapse = (";"))
  ) 

# unique(Overlap$Sectors)

Overlap %>% 
  filter(Sectors == "Aquaculture;Aquaculture;Capture")
# Not realy, just 40 records out of 2000, many of them "Something.nei"


```



```{r Spp_Function, eval =T}

#### Dummy Variables #####

Dummy_Data <- data.frame(
  Species = c(rep(SAU_Clean$scientific_name[1:10], times=3, each=1))) %>% 
  mutate(
    Country = rep(c("Brazil","Chile", "Peru"), times=1, each=10),
    Year = 2016,
    Landings_Tonnes = rnorm(30,2000,150),
    Landings_Value = rnorm(30,2000,150),
    Aquaculture_Tonnes = rnorm(30,1000,50),
    Aquaculture_Value = rnorm(30,1000,50),
    Imports_Tonnes = rnorm(30,1000,50),
    Imports_Value = rnorm(30,1000,50),
    Exports_Tonnes = rnorm(30,1000,50),
    Exports_Value = rnorm(30,1000,50)
  )

Dummy_DataB <- data.frame(
  Species = c(rep(SAU_Clean$scientific_name[1:10], times=3, each=1))) %>% 
  mutate(
    Country = rep(c("Brazil","Chile", "Peru"), times=1, each=10),
    Year = 2016,
    Variable = rep(c("Tonnes","Value","Tonnes"), times=10, each=1),
    Catch = rnorm(30,2000,150),
    Discards = rnorm(30,0.5,0.1),
    # Landings_Value = rnorm(30,2000,150),
    Aquaculture = rnorm(30,1000,50),
    # Aquaculture_Value = rnorm(30,1000,50),
    Imports = rnorm(30,1000,50),
    # Imports_Value = rnorm(30,1000,50),
    Exports = rnorm(30,1000,50),
    DHC = rnorm(30,0.5,0.1)
    # Exports_Value = rnorm(30,1000,50)
  )

write.csv(Dummy_DataB,
          "Dummy_Data.csv",
          row.names = F)

Spp_Analysis(
  Data = Dummy_DataB,
  Spp = Dummy_DataB$Species,
  Co = Dummy_DataB$Country, #c("Chile","Brazil"), "Brazil",
  Y = 2016,
  Var = "Tonnes",
  Top = 5,
  Result = "P"
)

# Catch times proportion to DHC from Tim + Aquaculture production + Import production - Exports
# NOTE IMPORTS FOR DIC
# LS <- Catch - (CATCH * Discards)# Landing supply (TDS)
# SHC <- LS - (LS * NHC) # HS = Not human suman consumption (SHC)
# LHC <- (SHC * PL) # PL is Processing lost (LHC)
# Nsp <- LHC + AP + I_DHC NEt seafood supply

# NSP <- Catch - TDS - TNHC - TPL + AP + I_DHC - Exp 


#### OLD VARIABLES ####
# Dis,
#   Spp, #Specie (es)
#   Co, #Country(es) (Brazil, Chile, Peru)
#   Y, # Year (es) NOTE if more than one function will return mean +- sd
#   Var, # Tonnes, Value, Both
#   Top,# number of species to show
#   Result # P = Plot or D = dataset
####

corefx <- function(
  Catch,
  Dis,
  NHC,
  PL,
  ADis,
  I_DHC,
  Exp
){
  
  # First Step 
  TDS <- Catch - Dis #TDS Discard fish befor landings
  LS <- Catch - TDS # LS Landings supply 
  
  # Second Step
  HS <- LS * NHC # Landings supply that does NOT go to DHC
  SHC <- LS - HS # Landings supply that goes to DHC
  
  # Third Step
  LP <- SHC * PL #Lost in processing 
  LHC <- SHC - LP # Final landings after processing losses 
  
  # Fourth Step (Aquaculture)
  ADS <- AP * ADis # Lost of aquaculture production by discards 
  AHC <- AP - ADS # Aquaculture production - losses in processing
  
  # Final step
  NSP <- (LHC + AHC + I_DHC) - Exp  # National fish food supply 
  
  # First general filter according to parameters
  Spp_Data <- Data %>% 
    filter(
      Species %in% Spp,
      Country %in% Co,
      Year %in% Y
    )
  
  # Just Tonnage results
  if( Var == "Tonnes"){
    
    Result <- Spp_Data %>%
      filter(Variable %in% Var) %>% 
      group_by(Species,
               Country) %>% 
      mutate(
        DHC_Available = (((Catch - (CATCH * Discards)) * DHC) + Aquaculture + Imports_DHC) - Exports,
        Catch_IHC = ((Catch * Discards) * (1-DHC))*-1 # Visually negative
      ) %>% 
      group_by(Country) %>% 
      top_n(n = Top, wt = DHC_Available) %>% 
      # Anoying GGPLOT comands for plotting niceley
      mutate(Exports = Exports*-1) %>% 
      select(-Variable,
             -Year,
             -DHC) %>% 
      gather("Concept","Value",3:8) %>% 
      mutate(
        Levels = factor(ifelse(Concept == "Aquaculture","AA_Aqua",
                               ifelse(Concept == "Catch", "AAA_Cat",
                                      ifelse(Concept == "Imports", "AAA_Imp",
                                             ifelse(Concept == "DHC_Available", "A_DH",
                                                    ifelse(Concept == "Exports", "B","NA")))))
        )
      )
    
    Plot <- ggplot(Result,
                   aes(
                     x = Species,
                     y = Value,
                     fill = Levels
                   )
    )+
      geom_bar(stat = "identity") +
      facet_wrap(~Country,
                 scales = "free") +
      scale_fill_discrete(
        labels=c("DHC","Aquaculture","Catch","Imports","Exports","IHC"),
        name="Component")
  } # Close Tonnnes ifstatement
  
  # Just Value results
  if( Var == "Value"){
    
    Result <- Spp_Data %>%
      filter(Variable %in% Var) %>% 
      group_by(Species,
               Country) %>% 
      mutate(
        # Catch times proportion to DHC from Tim + Aquaculture production + Import production - Exports
        Value_DHC = ((Catch * DHC) + Aquaculture + Imports) - Exports,
        Value_IHC = Catch * (1-DHC)
      ) %>% 
      group_by(Country) %>% 
      top_n(n = Top, wt = Value_DHC) %>% 
      # Anoying GGPLOT comands for plotting niceley
      mutate(Imports = Imports*-1) %>% 
      select(-Variable,
             -Year,
             -DHC) %>% 
      gather("Concept","Value",3:8) %>% 
      mutate(
        Levels = factor(ifelse(Concept == "Aquaculture","AA_Aqua",
                               ifelse(Concept == "Catch", "AAA_Cat",
                                      ifelse(Concept == "Exports", "AAA_Exp",
                                             ifelse(Concept == "Value_DHC", "A_DH",
                                                    ifelse(Concept == "Value_IHC", "AA_IH",
                                                           ifelse(Concept == "Imports", "B","NA"))))))
        )
      )
    
    
    # The plot !
    ggplot(Result,
           aes(
             x = Species,
             y = Value,
             fill = Levels
           )
    )+
      geom_bar(stat = "identity") +
      facet_wrap(~Country,
                 scales = "free") +
      scale_fill_discrete(
        labels=c("DHC","Aquaculture","IHC","Catch","Exports","Imports"),
        name="Component")
    
  } #Closes value if statement
  
  # Both Tonnage and Value results
  if( Var == "Both"){
    
    Result <- Spp_Data %>%
      group_by(Species,
               Country,
               Variable) %>% 
      mutate(
        # Catch times proportion to DHC from Tim + Aquaculture production + Import production - Exports
        Totals = ((Catch * DHC) + Aquaculture + Imports) - Exports 
      ) %>% 
      spread(Variable,Totals)
  } #CLoses both ifstatement
  
  
  # Function return
  
  return(Plot)  
  # if(Result == "P"){
  #   return(Plot)
  # }else{
  #   return(Result)
  # }
  
} # End of function




```

### Trade data
- Estimate imports and exports of fish for each country form the UN come-trade database

#### Methods Notes:

- Data set does not contain weight information, just US dollars
- "Fish and crustaceans, mollusks and other aquatic invertebrates" is the only classification for all three countries
- Exports - Imports - Re-Imports 

#### Questions to discuss with the team:
- What are "re-import"? Do we consider them? I'm assuming that they cost money to the country re-importing

```{r UN_Cometrade_Data, eval = T, echo = T, warning =F, message = F, fig.width= 10}

#File name
UN_F_Name <- "UN_Comtrade_Statistics.csv"


UN <- fread(paste(Data_Path,UN_F_Name,
                  sep = ""))

# Data exploration

# head(UN)
# names(UN)
# unique(UN$Commodity) # [1] "Fish and crustaceans, molluscs and other aquatic invertebrates
# unique(UN$Reporter) # [1] "Brazil" "Chile"  "Peru"  
# min(UN$Year) # 2013
# max(UN$Year) #2017

# max(UN$Gross_weight_kg)


# write.csv(UN_Clean,
#           "UN_Dataset.csv",
#           row.names = F)

#### Trade Graph ####

UN_Clean <-
  UN %>% 
  filter(Year == Year_an) %>% 
  group_by(Reporter,
           Trade_Flow
  ) %>% 
  summarise(
    Trade_Value = sum(Trade_Value_US, na.rm =T)
  ) %>% 
  spread(Trade_Flow,Trade_Value) %>% 
  mutate(
    Net_Trade_Value = (Export-Import),
    Net_Re_Import_value = ifelse(!is.na(`Re-Import`),(Net_Trade_Value -`Re-Import`),Net_Trade_Value)
  ) %>% 
  tidyr::gather("Action","Value",2:6) %>%
  filter(!Action %in% c("Re-Import","Net_Export_Value","Net_Re_Import_value")) %>% 
  ggplot(.,
         aes(
           x = Action,
           y = Value/1000000,
           # colour = Action
           fill = Action
         )
  ) +
  # geom_point()
  geom_bar(stat = "identity") +
  facet_wrap(~Reporter) +
  scale_fill_manual(values =c("green4", # Export
                              "red", # Import
                              "blue" # Totals
  )
  ) +
  theme_classic() +
  theme(legend.position = "top") +
  coord_flip() +
  labs(title="",
       x ="Countries",
       y = "Million US Dollars"
  )


#### Trade Graph With Landings ####


# UN_Clean <-
UN %>% 
  filter(Year == Year_an) %>% 
  group_by(Reporter,
           Trade_Flow
  ) %>% 
  summarise(
    Trade_Value = sum(Trade_Value_US, na.rm =T)
  ) %>% 
  spread(Trade_Flow,Trade_Value) %>% 
  mutate(
    Net_Trade_Value = (Export-Import),
    Net_Re_Import_value = ifelse(!is.na(`Re-Import`),(Net_Trade_Value -`Re-Import`),Net_Trade_Value)
  ) %>% 
  left_join(Totals,
            by = "Reporter") %>% 
  mutate(Fish_Industry_Total = Net_Trade_Value + Landings_Value) %>% 
  select(1:3,5,10) %>% 
  tidyr::gather("Action","Value",2:5) %>%
  ggplot(.,
         aes(
           x = Action,
           y = Value/1000000,
           # colour = Action
           fill = Action
         )
  ) +
  # geom_point()
  geom_bar(stat = "identity",
           width = 0.5 #Bar size
  ) +
  facet_wrap(~Reporter) +
  scale_fill_manual(values =c("green4", 
                              "blue", 
                              "red", 
                              "green3",
                              "skyblue"
  )
  ) +
  theme_classic() +
  theme(legend.position = "top") +
  coord_flip() +
  labs(title="",
       x ="Countries",
       y = "Million US Dollars"
  )





```

### Analysis

- Merge data-sets and estimate total tons of fish and revenue from fishing activity

#### Methods Notes

- Total fishing value + Net exportation gain

#### Questions to discuss with the team


```{r Analysis, eval = F, echo = T, warning =F, message = F}

# Merge Datasets ####

SAU_Clean %>% 
  left_join(UN_Clean,
            by = "Reporter") %>% 
  mutate(
    Total_Fishing_Value = Total_value + Net_Re_Import_value
  ) %>% 
  ggplot(.,
         aes(
           x = Reporter,
           y = Total_Fishing_Value,
           fill = Reporter
         )) +
  geom_bar(stat = "identity") +
  theme_classic()

```