---
title: "International Analysis"
output:
  pdf_document: default
  html_notebook: default
  html_document:
    df_print: paged
editor_options: 
  chunk_output_type: console
---

```{r setup, eval=T, echo=F, warning=F,message=F}

#### READ ME !!! ####
# Run this chunk before knit so you make sure you have all pkgs installed in R

ipak <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg)) 
    install.packages(new.pkg, dependencies = TRUE)
  sapply(pkg, require, character.only = TRUE)
}

#### Library ####
packages <- c(
  # "readxl", # Read dataframe
  "dplyr", # Data manipulation
  "tidyr", # Data manipulation
  "ggplot2", #Nice grpahs and spatial analysis
  "wesanderson",
  "plotly",
  "stringr",
  "rgdal",
  # "RColorBrewer",
  "knitr",
  # "kableExtra",
  "data.table",
  # "ggrepel",
  # "gridExtra",
  # "ggmap",
  "rgeos",
  "sp",
  "rgdal", #Spatial analysis
  "tools" #Spatial analysis
)

suppressWarnings(
  suppressMessages(
    ipak(packages)
  )
)

## Set WD for markdown file 

setwd("~/Documents/Github/Oceana_LA/international")

### Set up pannel 

# Choose countries to analyze
Countries <- c("Brazil","Chile","Peru")
# Year(s) to be analized
Year_an <- 2014

```

### Landings data
- Estimate landings and revenue for each country form the Sea Around Us (http://www.seaaroundus.org/) database. 

#### Notes

- Using reconstructed catch
- Filter out external countries (China, South Korea and "unknown")
- Removed Chile's reported landings in Peruvian waters

#### Questions to discuss with the team:
- Should we remove Recreational landings? 
- Removed Chile's reported landings in Peruvian waters?

```{r SAU_Landings_Data, eval = T, echo = T, warning =F, message = F, fig.height = 15, fig.width= 10}

#Data Path
Data_Path <- "./information/raw_databases/SAU/"
# File name
SAU_F_Name <- "SAU EEZ 76,969,77,970,604,152,153,154,155 v47-0.csv"
#read dataset
SAU <- fread(paste(Data_Path,SAU_F_Name,
                   sep = ""))
# Data exploration
# names(SAU)
# head(SAU)
# unique(SAU$fishing_sector) # "Industrial"   "Subsistence"  "Artisanal"    "Recreational"

# Countries excluded from the analysis
unique(SAU$fishing_entity) # There are 29 countries fishing in these waters, fill filter them
Countries <- c("Brazil","Chile","Peru")
unique(SAU$area_name)
#Main fisheries

SAU$scientific_name <- gsub(" ", "\n",SAU$scientific_name)

# Plot <- #For dynamic plot
SAU_Clean <- # FOr saving the plot
  SAU %>% 
  filter(scientific_name != "Marine\nfishes\nnot\nidentified") %>%  #Removed but top in B and P
  filter(fishing_entity %in% Countries) %>% # Remove other fishing nations
  group_by(year,
           scientific_name, # Trade data is too generic for species details
           fishing_entity#,
           # fishing_sector # #Trade data is too generic for sector details
  ) %>%
  summarise(
    Total_tonnes = sum(tonnes),
    Landings_Value = sum(landed_value)
  ) %>%
  filter(year == Year_an) %>%  # Choose year to be analyzed
  rename(Reporter = fishing_entity) %>%  # Change name of variable to match UN trade dataset
  # filter(area_name != "Peru" | Reporter != "Chile") %>% 
  tidyr::gather("Variable","Value",4:5)  %>% 
  group_by(Reporter,Variable) %>%
  top_n(n = 10, wt = Value) %>%  # Top 10, change if interactive plot
  # Determine what species are in both "Top" categories
  group_by(Reporter,scientific_name) %>%  
  mutate(Repeated = n()) %>% 
  mutate(Repeated = ifelse(Repeated == 1, "No", "Yes"))

# Plot 
ggplot(SAU_Clean,
       aes(
         x= reorder(scientific_name,-Value),
         y = Value/1000, #thousands
         fill = Repeated
       )
) +
  geom_bar(stat = "identity") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1,
                                   face = "italic")
  ) +
  scale_fill_manual(values =c("darkred",
                              "darkgreen"),
                    name ="Repeated") +
  facet_wrap(~Reporter + Variable,
             scales = "free",
             ncol = 2) +
  labs(title="Top 25 species by landings (left) and value (right)\n from the SAU dataset",
       x ="Species",
       y = "Values \n (Thousand of Tonns & US Dollars)"
  )


# For interactive plot
# Name the plot and then call it
# ggplotly(g_plot)


## Totals per Country ####

SAU_Tot <- SAU %>% 
  group_by(area_name,
           year,
           # scientific_name, # Trade data is too generic for species details
           fishing_entity#,
           # fishing_sector # #Trade data is too generic for sector details
  ) %>% 
  summarise(
    Total_tonnes = sum(tonnes),
    Landings_Value = sum(landed_value)
  ) %>% 
  filter(fishing_entity %in% Countries, # Remove China, Korea and unknown fishing country
         year == Year_an) %>%  # Choose year to be analyzed
  rename(Reporter = fishing_entity) %>%  # Change name of variable to match UN trade dataset
  filter(area_name != "Peru" | Reporter != "Chile") # Remove Chile report in Peruvean waters*

head(SAU_Clean)

# names(SAU_Clean)
# head(SAU_Clean)
# unique(SAU_Clean$fishing_entity)

# Clenaed!

#Write csv
# write.csv(SAU_Clean,
#           "SAU_Dataset.csv",
#           row.names = FALSE)


#### Proportion of the catch ####

Totals <- SAU %>% 
  filter(scientific_name != "Marine\nfishes\nnot\nidentified") %>%  #Removed but top in B and P
  filter(fishing_entity %in% Countries) %>% # Remove other fishing nations
  group_by(
    year,
    fishing_entity
  ) %>%
  summarise(
    Total_tonnes = sum(tonnes),
    Landings_Value = sum(landed_value)
  ) %>%
  filter(year == Year_an) %>% 
  ungroup() %>% 
  select(-year) %>% 
  tidyr::gather("Variable","Totals",2:3)

SAU_Spp <- SAU %>% 
  filter(scientific_name != "Marine\nfishes\nnot\nidentified") %>%  #Removed but top in B and P
  filter(fishing_entity %in% Countries) %>% # Remove other fishing nations
  group_by(
    year,
    scientific_name, # Trade data is too generic for species details
    fishing_entity
  ) %>%
  summarise(
    Total_tonnes = sum(tonnes),
    Landings_Value = sum(landed_value)
  ) %>%
  filter(year == Year_an) %>% 
  ungroup() %>% 
  select(-year) %>% 
  tidyr::gather("Variable","Partials",3:4) %>% 
  left_join(Totals,
            by = c("fishing_entity", "Variable")) %>% 
  mutate(
    Proportion = round((Partials/Totals)*100,2)
  ) %>% 
  group_by(fishing_entity,Variable) %>%
  top_n(n = 10, wt = Proportion) %>% 
  select(-4:-5) %>% 
  rename(Reporter = fishing_entity) %>%
  left_join(SAU_Clean,
            by = c("scientific_name","Reporter","Variable"))%>%  
  mutate(Repeated = n()) %>% 
  mutate(Repeated = ifelse(Repeated == 1, "No", "Yes"))

Prop_Total <- SAU_Spp %>% 
  group_by(Reporter,Variable) %>% 
  summarise(
    Tot_Prop = sum(Proportion),
    Location = max(Value)
  )


ggplot() +
  geom_bar(data = SAU_Spp,
           aes(
             x= reorder(scientific_name,-Value),
             y = Value/1000, #thousands
             fill = Repeated
           ),
           stat = "identity"
  ) +
  geom_label(data = SAU_Spp,
             aes(
               x = reorder(scientific_name,-Value),
               y = Value/1000,
               label = paste(as.character(Proportion),"%",sep = " ")
             )
  ) +
  geom_label(data = Prop_Total,
             aes(
               x = SAU_Spp$scientific_name[10],
               y = Location/1000,
               label = paste(as.character(Tot_Prop),"%",sep = " ")
             )
  ) +
  theme(axis.text.x = element_text(angle = 45,
                                   hjust = 1,
                                   face = "italic")
  ) +
  scale_fill_manual(values =c("darkred",
                              "darkgreen"),
                    name ="Repeated") +
  facet_wrap(~Reporter + Variable,
             scales = "free",
             ncol = 2) +
  labs(title="Top 25 species by landings (left) and value (right)\n from the SAU dataset",
       x ="Species",
       y = "Values \n (Thousand of Tonns & US Dollars)"
  )


```

```{r SOFIA_Data, eval = T, echo = T}

#### FAO Data ####

#Data Path
Data_Path <- "./information/raw_databases/FAO/"
# File name
FAO_F_Name <- "INPUT FAO Fishstat 2018.csv"
#read dataset
FAO <- read.csv(paste(Data_Path,FAO_F_Name,
                      sep = ""))

# head(FAO)
# names(FAO)
# unique(FAO$Country)

#### Cleaning Catch FAO data####

# We selected Brazil, Chile and Peru landings and aquaculture and filter the data from 2010 to 2016

Clean_FAO_C <- FAO %>% 
  filter(Country %in% Countries,
         Sector != "Trade") %>% # Select only Brazil, Chile and Peru
  group_by(Country,
         Group,
         # Environment, # NOTE: not identifying between marine/freshwater
         Sector,
         # Trade.Flow, # No need its all Production anyway
         Unit) %>% 
  summarise_at(vars(matches("X201")), sum, na.rm=T) %>% # This fixes the FAO fishing area issue
  gather("Year","Value",5:11) %>% 
  spread(Sector,Value) # Spread catches and aquaculture


#### Data Check METHODS ALERT ####
# Double check why are we having double values (e.g. Patagonian.grenadier in chile) #
# Beacuse of the FAO fishing area (Atlantic.Southwes and pacific.Southwest). I believe Oceana does not care about that so I'm adding it up! 

Check_Clean_FAO_C <- FAO %>% 
  filter(Country %in% Countries,
         Sector != "Trade") %>% 
  filter( Group == "Patagonian.grenadier")

#### Cleaning Trade FAO data####

# We selected Brazil, Chile and Peru landings and aquaculture and filter the data from 2010 to 2016. We then aggregated the data for each country, year, species and tradeflow. We lost the source detail (e.g. freshwater of saltwater).

Clean_FAO_T <- FAO %>% 
  filter(Country %in% Countries,
         Sector == "Trade") %>% # Select only Brazil, Chile and Peru
  select(Country,
         Group,
         Environment,
         Sector,
         Trade.Flow,
         Unit,
         X2010:X2016) %>% 
  gather("Year","Value",7:13) %>% 
  group_by(
    Group, # NOTE: not identifying between marine/freshwater
    Country,
    Year,
    Unit,
    Trade.Flow#,
    # Sector
  ) %>% 
  summarise(Value = sum(Value)) %>% 
  filter(Trade.Flow != "Production") %>% 
  spread(Trade.Flow,Value)

# head(Clean_FAO_C)
# names(Clean_FAO_C)
# unique(Clean_FAO_C$Country)
# unique(Clean_FAO_C$Sector)
# unique(Clean_FAO_C$Group)
# unique(Clean_FAO_C$Environment)

#### Overall production per Sector FAO ####

Totals <- Clean_FAO_C %>% 
  group_by(Country,
           Sector,
           Trade.Flow,
           Unit) %>% 
  summarise(
    Mean = mean(Value, na.rm=T)) #%>% 
# filter(Unit != "Number",
#        Sector != "Trade" | Trade.Flow != "Production"
#        )#Until we figure out this

ggplot(Totals,
       aes(
         x = Sector,
         y = Mean/1000, #thousands
         fill = Trade.Flow
       )
) +
  geom_bar(stat = "identity") +
  facet_wrap(~ Country + Unit,
             ncol = 2,
             scales = "free")


#### Per Species ####

head(Clean_FAO_C)

Spp_FAO <- Clean_FAO_C %>% 
  # filter(scientific_name != "Marine\nfishes\nnot\nidentified") %>%  #Removed but top in B and P
  group_by(
    Country,
    Sector, # Trade data is too generic for species details
    Group,
    Trade.Flow,
    Unit
  ) %>%
  summarise_at(vars(matches("X20")), sum, na.rm=T) %>% 
  group_by(Country,
           Sector,
           # Group,
           Trade.Flow,
           Unit) %>%
  # top_n(n = 10, wt = X2016) %>% 
  filter(Unit != "Number",
         Sector != "Trade" | Trade.Flow != "Production" #Until we figure out this
  ) %>% 
  select(-X2015,-X2014) %>% 
  mutate(Year = 2016) %>% 
  rename(Value = X2016)



# Are there any species in different Sectores per country?

Overlap <- Spp_FAO %>% 
  group_by(Country,
           Group,
           Trade.Flow) %>%
  summarise(n(),
            Sectors = paste(Sector,
                            collapse = (";"))
  ) 

# unique(Overlap$Sectors)

Overlap %>% 
  filter(Sectors == "Aquaculture;Aquaculture;Capture")
# Not realy, just 40 records out of 2000, many of them "Something.nei"


#### __________Alfredo's Data__________ ####
Data_Path <- "./information/raw_databases/"

FISHMAR_F_Name <- "Alfredo_data.csv"
#read dataset
FISHMAR <- read.csv(paste(Data_Path,FISHMAR_F_Name,
                      sep = ""))

head(FISHMAR)


#### Standarizing both datasets ####
# Column names differe and in Alfredo's data the names are separated by "," and spaces while FAO have them by "."

### Cleaning FISHMAR data ####

Clean_FISHMAR <- FISHMAR

names(Clean_FISHMAR)
head(Clean_FISHMAR)

# Change "," and " " into "." to match FAO's data
Clean_FISHMAR$Commodity <- Clean_FISHMAR$Commodity %>% 
  gsub( ", ",".",.) %>%  # Change ","
  gsub( " ",".",.) # Change " "

head(Clean_FISHMAR$Commodity,20)
head(FAO$Group,20)

Clean_FISHMAR <- Clean_FISHMAR %>% 
  rename(Group = Commodity)


# Also remove spaces in common names for FAO

Clean_FISHMAR$Comm.Name <- Clean_FISHMAR$Comm.Name %>% 
  gsub( ", ",".",.) %>%  # Change ","
  gsub( " ",".",.) # Change " "


# #### Comparing datasets by Trade Group ####
# 
# # What in FAO is represented in Alfredo's data
# FAO_Trade <- Clean_FAO_C %>% 
#   filter(Sector == "Trade") # 3672 observations in "Sector == Trade"
#   
# unique(FAO_Trade$Group)
# length(unique(FAO_Trade$Group)) # 531 different procuts
# 
# Semi_FAO_FISHMAR <- FAO_Trade %>% 
#   semi_join(Clean_FISHMAR,
#             by = "Group") # 1194 of Alfredo's info are on FAO's
# 
# unique(Semi_FAO_FISHMAR$Group)
# length(unique(Semi_FAO_FISHMAR$Group)) # 174 different products
# 
# # Proportion of FAO explained by Alfredo's data
# 
# (174/531)*100 # only 32.76836 percent 

# # What in FAO is NOT represented in Alfredo's data
# Anti_FAO_FISHMAR <- Clean_FAO_C %>% 
#   filter(Sector == "Trade") %>% # 3672 observations in "Sector == Trade"
#   anti_join(Clean_FISHMAR,
#             by = "Group") # 1194 of Alfredo's info are on FAO's
# 
# unique(Anti_FAO_FISHMAR$Group)
# length(unique(Anti_FAO_FISHMAR$Group)) # 357
# 
# # Just making sure
# 174 + 357 # matching + no matching = total in FAO (Checked!)
# 
# ### Missing Names in Alfredo's data ####
# 
# ## Manually checked those that do not match and found that Bonitos is a good example to talk to Alfredo
# 
# Boni_FAO <- Clean_FAO_C %>% 
#   filter(str_detect(Group,"Bonito")) %>% 
#   select(Group)
# 
# Boni_FISHMAR <- Clean_FISHMAR %>% 
#   filter(str_detect(Group,"bonito")) %>% 
#   select(Group)
# 
# Both <- data.frame(
#   FAO = unique(Boni_FAO$Group),
#   FISHMAR =unique(Boni_FISHMAR$Group)
# )
# 
# ## For example, FISHMAR has "Plain.bonito.frozen" and FAO has "Bonito.frozen" In total FISHMAR has 15 different Bonito valies, while FAO only 3...


#### Comparing datasets by Species (using common names) ####

# What in FAO is represented in Alfredo's data
FAO_Production <- Clean_FAO_C %>% 
  rename(Comm.Name = Group)
  
length(unique(FAO_Production$Comm.Name)) # 396 different procuts

Semi_FAO_FISHMAR_Spp <- FAO_Production %>% 
  semi_join(Clean_FISHMAR,
            by = "Comm.Name") # 124 of Alfredo's info are on FAO's

unique(Semi_FAO_FISHMAR_Spp$Comm.Name)
length(unique(Semi_FAO_FISHMAR_Spp$Comm.Name)) # 83 different products

# Proportion of FAO explained by Alfredo's data

(83/356)*100 # only 23.31 percent 

# Whats not in there

Anti_FAO_FISHMAR_Spp <- FAO_Production %>% 
  anti_join(Clean_FISHMAR,
            by = "Comm.Name") # 4 of Alfredo's info are on FAO's


#### I guess we:
  # a ) Assume that whatever is not here is not tradable or...
  # b) We did our best to match trade with species (Probably better)

#### Datasets to Merge ####

# We merge the FAO Trade data with the FISHMAR trade data to know what captured species represent each trade groups...

Final_FAO_Data <- Clean_FISHMAR %>% 
  select(
    Country,
    Comm.Name,
    Sci.Name.Fb,
    Group=Commodity) %>% 
  # Join dataset of trade by FAO's group variable and Alfredo's Commodity variable
  left_join(Clean_FAO_T,
            by = c("Country","Group")
  ) %>%
  # Aggregate the trade values of each species by the original FAO group (one species can include multiple groups)
  group_by(
    Country,
    # Group, # 
    Sci.Name.Fb,
    Group= Comm.Name, #Merge with Catch by this
    Unit,
    Year,
    Unit
  ) %>%
  summarise_at(c("Exports","Imports"),sum,na.rm=T) %>% 
  # And now we merge the FAO catch data with the data
  left_join(Clean_FAO_C,
            by = c("Group","Country","Unit","Year")
  )


```


```{r Tim_Data, eval = T, echo = F}

### Species info name ###
# Tim only included species names and I need common names for FAO's data

#Data Path
Data_Path <- "./information/raw_databases/SAU/"
# File name
SAU_F_Name <- "SAU EEZ 76,969,77,970,604,152,153,154,155 v47-0.csv"
#read dataset
SAU_Spp <- fread(paste(Data_Path,SAU_F_Name,
                   sep = "")) %>% 
  rename(taxon_name = scientific_name) %>% 
  group_by(taxon_name,
           common_name) %>%
  summarise(n=n()) %>%
  select(-n)

# Tim's data ####
Tim_D <- fread("./information/raw_databases/SAU/Brazil-Peru-Chile Fisheries Data.csv")

# Im going to use the average DHC and IHC value of all secotrs (Artisanal/Industrial) and reporting status (official/reconstructed) I dont think it matters 


Clean_Tim <- Tim_D %>% 
  filter(year >= 2010) %>% 
  select(2,3,8:17) %>% 
  left_join(SAU_Spp,
            by = "taxon_name") %>% 
  mutate(
    Year = paste("X",year,sep="")
  ) %>% 
  group_by(
    Year,
    # Discards_rate, # They are all 0 or 1???
    Country = fishing_entity, #change names
    Comm.Name = common_name,
    Sci.Name.Fb = taxon_name
  ) %>% 
  summarise_at(c("DHC_Use","FMFO_Use","Other_Use"),mean,na.rm=T) %>% 
  rowwise() %>% 
  mutate(
    IHC = sum(c(FMFO_Use,Other_Use),na.rm = T)
  )

length(unique(Clean_Tim$Sci.Name.Fb)) #462, better


## Change spaces and "," for "."

# Change "," and " " into "." to match FAO's data
Clean_Tim$Group <- Clean_Tim$Group %>% 
  gsub( ", ",".",.) %>%  # Change ","
  gsub( " ",".",.) # Change " "


# Do they even match?

Semi_FAO_Tim <- Clean_FAO_C %>% 
  semi_join(Clean_Tim,
            by ="Group") # only 179...

Anti_FAO_Tim <- Clean_FAO_C %>% 
  anti_join(Clean_Tim,
            by ="Group")

# Plot discard frequencies... o and 1

Tim_D %>% 
  mutate(
    Discard_rate = Discards/sum
  ) %>% 
ggplot(.) +
  geom_histogram(
    aes(
    x = Discard_rate
  ),
  bins = 30
  )


```

```{r Spp_Function, eval =T}

#### Dummy Variables #####


Dummy_Data <- data.frame(
  Species = c(rep(FAO_Dummy$Group[41:50], times=3, each=1))) %>% 
  mutate(
    Country = rep(c("Brazil","Chile", "Peru"), times=1, each=10),
    Year = 2016,
    Variable = rep(c("Tonnes","Value","Tonnes"), times=10, each=1),
    Catch = rnorm(30,2000,150),
    Discards = rnorm(30,0.5,0.1),
    # Landings_Value = rnorm(30,2000,150),
    Aquaculture = rnorm(30,1000,50),
    # Aquaculture_Value = rnorm(30,1000,50),
    Imports = rnorm(30,1000,50),
    # Imports_Value = rnorm(30,1000,50),
    Exports = rnorm(30,1000,50),
    DHC = rnorm(30,0.5,0.1)
    # Exports_Value = rnorm(30,1000,50)
  )

# # Remove "X" from year to make it numeric
# FAO_Dummy$Year<- gsub(
#   "X", "", FAO_Dummy$Year)


International_Dataset <- Final_FAO_Data %>% 
  left_join(Clean_Tim,
            by = c(
              "Year",
              "Country",
              "Comm.Name",
              "Sci.Name.Fb")
            )



FAO_Dummy <- Clean_FAO_C %>% 
  gather("Year","Value",7:13) %>% 
  filter(Year == "X2014") %>% 
  group_by(
    Comm.Name = Group, # NOTE: not identifying between marine/freshwater
    Country,
    Year,
    Unit,
    # Trade.Flow,
    Sector
    ) %>% 
  summarise(Value = sum(Value)) %>% 
  spread(Sector,Value) %>% # First we split the sectors in catches, aqua and trade
  mutate(
    Discards = 0.20
  ) %>% 
  # Now we incorporate de Trade code from FISHMAR data
  left_join(FISHMAR_Merge,
            by = c("Country","Comm.Name","Year","Unit","Sci.Name.Fb")
  ) %>% 
  # Now we incorporate DHC/IHC from Tim's database
  left_join(Clean_Tim,
            by = c(
              "Year",
              "Country",
              "Comm.Name",
              "Sci.Name.Fb")
            )


#### Tests ###




  
  # Re arrenge variables
  # select(
  #   Sci.Name.Fb,
  #   Comm.Name,
  #   Group,
  #   Country,
  #   Year,
  #   Unit,
  #   Aquaculture,
  #   Capture,
  #   Exports,
  #   Imports,
  #   Reimports,
  #   Discards,
  #   DHC,
  #   IHC
  # )
  
  
  # Herring.nei.fillets.frozen
# Chile
  
  # rowwise() %>% # This is all to remove all rows with NA Ther's probably an easyer way but I'm too tired at this point...
  # mutate(
  #   Remove = sum(c(Aquaculture,Capture,Exports,Imports),na.rm = T)
  # ) %>% 
  # filter(Remove > 0)
  

Spp_Analysis(
  Data = FAO_Dummy,
  Spp = FAO_Dummy$Group,
  Co = Dummy_DataB$Country, #c("Chile","Brazil"), "Brazil",
  Y = 2016,
  Var = "Tonnes",
  Top = 5,
  Result = "P"
)

# Catch times proportion to DHC from Tim + Aquaculture production + Import production - Exports
# NOTE IMPORTS FOR DIC
# LS <- Catch - (CATCH * Discards)# Landing supply (TDS)
# SHC <- LS - (LS * NHC) # HS = Not human suman consumption (SHC)
# LHC <- (SHC * PL) # PL is Processing lost (LHC)
# Nsp <- LHC + AP + I_DHC NEt seafood supply

# NSP <- Catch - TDS - TNHC - TPL + AP + I_DHC - Exp 


#### OLD VARIABLES ####
# Dis,
#   Spp, #Specie (es)
#   Co, #Country(es) (Brazil, Chile, Peru)
#   Y, # Year (es) NOTE if more than one function will return mean +- sd
#   Var, # Tonnes, Value, Both
#   Top,# number of species to show
#   Result # P = Plot or D = dataset
####

corefx <- function(
  Catch,
  Dis,
  NHC,
  PL,
  ADis,
  I_DHC,
  Exp
){
  
  # First Step 
  TDS <- Catch - Dis #TDS Discard fish before landings
  LS <- Catch - TDS # LS Landings supply 
  
  # Second Step
  HS <- LS * NHC # Landings supply that does NOT go to DHC
  SHC <- LS - HS # Landings supply that goes to DHC
  
  # Third Step
  LP <- SHC * PL #Lost in processing 
  LHC <- SHC - LP # Final landings after processing losses 
  
  # Fourth Step (Aquaculture)
  ADS <- AP * ADis # Lost of aquaculture production by discards 
  AHC <- AP - ADS # Aquaculture production - losses in processing
  
  # Final step
  NSP <- (LHC + AHC + I_DHC) - Exp  # National fish food supply 
  
  # First general filter according to parameters
  Spp_Data <- Data %>% 
    filter(
      Species %in% Spp,
      Country %in% Co,
      Year %in% Y
    )
  
  # Just Tonnage results
  if( Var == "Tonnes"){
    
    Result <- Spp_Data %>%
      filter(Variable %in% Var) %>% 
      group_by(Species,
               Country) %>% 
      mutate(
        DHC_Available = (((Catch - (CATCH * Discards)) * DHC) + Aquaculture + Imports_DHC) - Exports,
        Catch_IHC = ((Catch * Discards) * (1-DHC))*-1 # Visually negative
      ) %>% 
      group_by(Country) %>% 
      top_n(n = Top, wt = DHC_Available) %>% 
      # Anoying GGPLOT comands for plotting niceley
      mutate(Exports = Exports*-1) %>% 
      select(-Variable,
             -Year,
             -DHC) %>% 
      gather("Concept","Value",3:8) %>% 
      mutate(
        Levels = factor(ifelse(Concept == "Aquaculture","AA_Aqua",
                               ifelse(Concept == "Catch", "AAA_Cat",
                                      ifelse(Concept == "Imports", "AAA_Imp",
                                             ifelse(Concept == "DHC_Available", "A_DH",
                                                    ifelse(Concept == "Exports", "B","NA")))))
        )
      )
    
    Plot <- ggplot(Result,
                   aes(
                     x = Species,
                     y = Value,
                     fill = Levels
                   )
    )+
      geom_bar(stat = "identity") +
      facet_wrap(~Country,
                 scales = "free") +
      scale_fill_discrete(
        labels=c("DHC","Aquaculture","Catch","Imports","Exports","IHC"),
        name="Component")
  } # Close Tonnnes ifstatement
  
  # Just Value results
  if( Var == "Value"){
    
    Result <- Spp_Data %>%
      filter(Variable %in% Var) %>% 
      group_by(Species,
               Country) %>% 
      mutate(
        # Catch times proportion to DHC from Tim + Aquaculture production + Import production - Exports
        Value_DHC = ((Catch * DHC) + Aquaculture + Imports) - Exports,
        Value_IHC = Catch * (1-DHC)
      ) %>% 
      group_by(Country) %>% 
      top_n(n = Top, wt = Value_DHC) %>% 
      # Anoying GGPLOT comands for plotting niceley
      mutate(Imports = Imports*-1) %>% 
      select(-Variable,
             -Year,
             -DHC) %>% 
      gather("Concept","Value",3:8) %>% 
      mutate(
        Levels = factor(ifelse(Concept == "Aquaculture","AA_Aqua",
                               ifelse(Concept == "Catch", "AAA_Cat",
                                      ifelse(Concept == "Exports", "AAA_Exp",
                                             ifelse(Concept == "Value_DHC", "A_DH",
                                                    ifelse(Concept == "Value_IHC", "AA_IH",
                                                           ifelse(Concept == "Imports", "B","NA"))))))
        )
      )
    
    
    # The plot !
    ggplot(Result,
           aes(
             x = Species,
             y = Value,
             fill = Levels
           )
    )+
      geom_bar(stat = "identity") +
      facet_wrap(~Country,
                 scales = "free") +
      scale_fill_discrete(
        labels=c("DHC","Aquaculture","IHC","Catch","Exports","Imports"),
        name="Component")
    
  } #Closes value if statement
  
  # Both Tonnage and Value results
  if( Var == "Both"){
    
    Result <- Spp_Data %>%
      group_by(Species,
               Country,
               Variable) %>% 
      mutate(
        # Catch times proportion to DHC from Tim + Aquaculture production + Import production - Exports
        Totals = ((Catch * DHC) + Aquaculture + Imports) - Exports 
      ) %>% 
      spread(Variable,Totals)
  } #CLoses both ifstatement
  
  
  # Function return
  
  return(Plot)  
  # if(Result == "P"){
  #   return(Plot)
  # }else{
  #   return(Result)
  # }
  
} # End of function




```

### Trade data
- Estimate imports and exports of fish for each country form the UN come-trade database

#### Methods Notes:

- Data set does not contain weight information, just US dollars
- "Fish and crustaceans, mollusks and other aquatic invertebrates" is the only classification for all three countries
- Exports - Imports - Re-Imports 

#### Questions to discuss with the team:
- What are "re-import"? Do we consider them? I'm assuming that they cost money to the country re-importing

```{r UN_Cometrade_Data, eval = T, echo = T, warning =F, message = F, fig.width= 10}

#File name
UN_F_Name <- "UN_Comtrade_Statistics.csv"


UN <- fread(paste(Data_Path,UN_F_Name,
                  sep = ""))

# Data exploration

# head(UN)
# names(UN)
# unique(UN$Commodity) # [1] "Fish and crustaceans, molluscs and other aquatic invertebrates
# unique(UN$Reporter) # [1] "Brazil" "Chile"  "Peru"  
# min(UN$Year) # 2013
# max(UN$Year) #2017

# max(UN$Gross_weight_kg)


# write.csv(UN_Clean,
#           "UN_Dataset.csv",
#           row.names = F)

#### Trade Graph ####

UN_Clean <-
  UN %>% 
  filter(Year == Year_an) %>% 
  group_by(Reporter,
           Trade_Flow
  ) %>% 
  summarise(
    Trade_Value = sum(Trade_Value_US, na.rm =T)
  ) %>% 
  spread(Trade_Flow,Trade_Value) %>% 
  mutate(
    Net_Trade_Value = (Export-Import),
    Net_Re_Import_value = ifelse(!is.na(`Re-Import`),(Net_Trade_Value -`Re-Import`),Net_Trade_Value)
  ) %>% 
  tidyr::gather("Action","Value",2:6) %>%
  filter(!Action %in% c("Re-Import","Net_Export_Value","Net_Re_Import_value")) %>% 
  ggplot(.,
         aes(
           x = Action,
           y = Value/1000000,
           # colour = Action
           fill = Action
         )
  ) +
  # geom_point()
  geom_bar(stat = "identity") +
  facet_wrap(~Reporter) +
  scale_fill_manual(values =c("green4", # Export
                              "red", # Import
                              "blue" # Totals
  )
  ) +
  theme_classic() +
  theme(legend.position = "top") +
  coord_flip() +
  labs(title="",
       x ="Countries",
       y = "Million US Dollars"
  )


#### Trade Graph With Landings ####


# UN_Clean <-
UN %>% 
  filter(Year == Year_an) %>% 
  group_by(Reporter,
           Trade_Flow
  ) %>% 
  summarise(
    Trade_Value = sum(Trade_Value_US, na.rm =T)
  ) %>% 
  spread(Trade_Flow,Trade_Value) %>% 
  mutate(
    Net_Trade_Value = (Export-Import),
    Net_Re_Import_value = ifelse(!is.na(`Re-Import`),(Net_Trade_Value -`Re-Import`),Net_Trade_Value)
  ) %>% 
  left_join(Totals,
            by = "Reporter") %>% 
  mutate(Fish_Industry_Total = Net_Trade_Value + Landings_Value) %>% 
  select(1:3,5,10) %>% 
  tidyr::gather("Action","Value",2:5) %>%
  ggplot(.,
         aes(
           x = Action,
           y = Value/1000000,
           # colour = Action
           fill = Action
         )
  ) +
  # geom_point()
  geom_bar(stat = "identity",
           width = 0.5 #Bar size
  ) +
  facet_wrap(~Reporter) +
  scale_fill_manual(values =c("green4", 
                              "blue", 
                              "red", 
                              "green3",
                              "skyblue"
  )
  ) +
  theme_classic() +
  theme(legend.position = "top") +
  coord_flip() +
  labs(title="",
       x ="Countries",
       y = "Million US Dollars"
  )





```

### Analysis

- Merge data-sets and estimate total tons of fish and revenue from fishing activity

#### Methods Notes

- Total fishing value + Net exportation gain

#### Questions to discuss with the team


```{r Analysis, eval = F, echo = T, warning =F, message = F}

# Merge Datasets ####

SAU_Clean %>% 
  left_join(UN_Clean,
            by = "Reporter") %>% 
  mutate(
    Total_Fishing_Value = Total_value + Net_Re_Import_value
  ) %>% 
  ggplot(.,
         aes(
           x = Reporter,
           y = Total_Fishing_Value,
           fill = Reporter
         )) +
  geom_bar(stat = "identity") +
  theme_classic()

```


### Map data SAU

```{r SAU_Map_Data, eval =T, echo = T}

#### FAO Data ####

#Data Path
Data_Path <- "./information/raw_databases/SAU/"
# File name
SAU_Space_F_Name <- "OceanaSpatialDataPeruChileBrazil.csv"
#read dataset
SAU_Spatial <- read.csv(paste(Data_Path,SAU_Space_F_Name,
                      sep = ""))


#### EEZ limits ####

path_eez_world <- ("/Users/jpalacios/Documents/UBC/Oceans_Project/Distribution/Data/Spatial/World_EEZ_v9_20161021/")
#The File
fnam_eez_world <- "eez_boundaries.shp"
#Load it!

#### Extract
eez_world <- readOGR(dsn = path_eez_world,
                     layer =file_path_sans_ext(fnam_eez_world))

Countries_Ar <- c(Countries,"Argentina")


#Subsetting South America
South_America <- eez_world[eez_world$Territory1 %in% Countries_Ar,]
unique(South_America@data$Territory1)


#### Countries shape ####

path.ne.coast <- "information/raw_databases/Spatial/TM_WORLD_BORDERS-0.3"
file_name <- "TM_WORLD_BORDERS-0.3.shp"

# Loading the shapefile:
World_Land <- readOGR(dsn = path.ne.coast, 
                      layer = file_path_sans_ext(file_name),
                      verbose = FALSE
                      )

# Central_A@data$NAME

South_Border <- c("Brazil",
                  "Peru",
                  "Chile",
                  "Argentina",
                  # "Colombia",
                  "Ecuador",
                  "Uruguay",
                  "Bolivia",
                  "Paraguay")


South_America_Land <- subset(World_Land, NAME %in% South_Border)

unique(South_America_Land@data$NAME)

# Getting Long and Lat data

Coor <- read.csv("/Users/jpalacios/Documents/UBC/Oceans_Project/Distribution/DBEM/Data/Lat_Lon_DBEM.txt")

colnames(Coor) <- c("cell_id","Long","Lat")

# Merging datasets
SAU_Coor <- SAU_Spatial %>%
  group_by(fishing_entity_id,
           cell_id) %>% 
  summarise(sum = sum(sum,na.rm=T)) %>% 
  mutate(Log = log10(sum)) %>% 
  left_join(Coor,
            by = "cell_id")
  
  
# The actual map

# Some Zissouy collors :)
pal <- wes_palette("Zissou1", 100, type = "continuous")

Psum <- ggplot() +
  geom_tile(data = SAU_Coor,
               aes(
                 x=Long,
                 y=Lat,
                 fill = sum
               )
               ) +
  geom_polygon(data = South_America_Land,
               aes(
                 x = long,
                 y = lat,
                 group = group,
                 color = NAME
               ),
               fill = "gray",
               colour = "black"
               ) +
  geom_path(data = South_America,
       aes(
         x = long,
         y = lat,
         group = group
       )
       ) +
  # ylim(-75,5) +
  # xlim(-85,-26) +
  coord_fixed(xlim = c(-85, -26),  
              ylim = c(-60, 5), ratio = 1.2)+
  # facet_wrap(~Type,
  #            scales = "free") +
  scale_fill_gradientn("Catch",colours = pal) +
  theme_classic() +
  theme(legend.position = "bottom")
  
Plog <- ggplot() +
  geom_tile(data = SAU_Coor,
               aes(
                 x=Long,
                 y=Lat,
                 fill = Log
               )
               ) +
  geom_polygon(data = South_America_Land,
               aes(
                 x = long,
                 y = lat,
                 group = group,
                 color = NAME
               ),
               fill = "gray",
               colour = "black"
               ) +
  geom_path(data = South_America,
       aes(
         x = long,
         y = lat,
         group = group
       )
       ) +
  # ylim(-75,5) +
  # xlim(-85,-26) +
  coord_fixed(xlim = c(-85, -26),  
              ylim = c(-60, 5), ratio = 1.2)+
  # facet_wrap(~Type,
  #            scales = "free") +
  scale_fill_gradientn("Catch",colours = pal) +
  theme_classic() +
  theme(legend.position = "bottom")

gridExtra::grid.arrange(Psum,
                        Plog,
                        ncol = 2)


```
